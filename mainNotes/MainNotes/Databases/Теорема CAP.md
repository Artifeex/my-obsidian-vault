![[Pasted image 20240927140624.png]]
![[Pasted image 20240927140643.png]]
Теорема CAP (от англ. *Consistency, Availability, Partition tolerance*) — это важная концепция в распределенных системах, которая описывает ограничения, с которыми сталкиваются такие системы при достижении надежности и производительности. Теорема была предложена в 2000 году Эриком Брюэром, и она утверждает, что распределенная система не может одновременно обеспечивать все три свойства: согласованность (Consistency), доступность (Availability) и устойчивость к разделению сети (Partition tolerance). По теореме, система может гарантировать только два из трех этих свойств.

### Разберем каждое из свойств CAP:

1. **Согласованность (Consistency)**:
   - Это свойство означает, что все узлы в системе всегда видят одни и те же данные в одно и то же время.
   - Например, если один из узлов изменяет данные, то все другие узлы мгновенно получают эту новую версию данных.
   - В терминах транзакций это можно сравнить с понятием строгой согласованности, где любое чтение после записи возвращает последнюю записанную версию данных.

2. **Доступность (Availability)**:
   - Система всегда отвечает на запросы к ней, даже если произошел сбой одного из узлов.
   - Если узел недоступен, система должна найти способ ответить на запросы пользователей за счет других узлов.
   - Это свойство делает систему высокодоступной, поскольку система не зависит от единственного узла и может обрабатывать запросы даже при частичном сбое.

3. **Устойчивость к разделению сети (Partition Tolerance)**:
   - Разделение сети (*Partition*) — это ситуация, когда узлы системы теряют связь друг с другом, например, из-за проблем с сетью.
   - Устойчивость к разделению означает, что система продолжает корректно работать, даже если между частями сети произошел сбой связи.
   - В реальных распределенных системах полностью избежать разделения невозможно, поэтому устойчивость к разделению обычно является обязательным требованием.

### Ограничение теоремы CAP

Теорема утверждает, что распределенная система может удовлетворять только двум из этих трех свойств одновременно:

- **CP (Consistency + Partition tolerance)**: система обеспечивает согласованность и устойчивость к разделению, но при этом жертвует доступностью. Пример — многие распределенные базы данных, такие как HBase и MongoDB в режиме строгой консистентности. Если происходит разделение сети, то система может отказаться от обработки запросов, чтобы сохранить согласованность данных.

- **AP (Availability + Partition tolerance)**: система обеспечивает доступность и устойчивость к разделению, но не гарантирует согласованности. Пример — системы с Eventual Consistency, такие как Cassandra, которые могут позволять временные несогласованности данных. После устранения разделения данные в конечном итоге приходят к согласованности, но на момент разделения могут существовать различия.

- **CA (Consistency + Availability)**: система обеспечивает согласованность и доступность, но не может выдерживать разделение. Такие системы возможны только при отсутствии разделения, то есть в локальной сети, где гарантирована постоянная связь между узлами. Пример — традиционные реляционные базы данных, работающие на одном сервере, но они не являются полностью распределенными системами в строгом смысле.

### Примеры использования CAP в реальных системах

- **CP системы (MongoDB, HBase в режиме строгой консистентности)**:
  - Используются там, где согласованность данных критически важна, например, в банковских и финансовых приложениях, где важно, чтобы данные всегда были точными.
  - Система может приостановить обработку запросов, если узлы не могут общаться между собой, чтобы избежать несогласованностей.

- **AP системы (Cassandra, DynamoDB)**:
  - Применяются в системах, где важна высокая доступность и отказоустойчивость, например, в социальных сетях или интернет-магазинах.
  - Эти системы могут допускать временные несогласованности, чтобы поддерживать доступность при сетевых разделениях.

- **CA системы (реляционные СУБД на одном сервере)**:
  - Обеспечивают строгую согласованность и доступность, но не выдерживают сетевые разделения.
  - Эти системы подходят для небольших проектов, которые не требуют высокой масштабируемости и могут работать в условиях локальной сети.

### CAP и реальный выбор в распределенных системах

На практике часто невозможно идеально удовлетворить два свойства и полностью игнорировать третье. Современные системы стремятся достичь **баланса между свойствами** и часто используют гибридные подходы. Например, в некоторых системах, таких как **Cassandra**, применяется принцип *Eventual Consistency* (конечная согласованность), где данные становятся согласованными через некоторое время после обновления, а также предоставляются механизмы для регулирования уровней согласованности, что позволяет настраивать баланс между C и A в зависимости от требований.

### Заключение

Теорема CAP — это базовый принцип, который помогает разработчикам распределенных систем осознанно выбирать компромиссы между согласованностью, доступностью и устойчивостью к разделению сети. Понимание ограничений и возможностей CAP помогает принимать обоснованные решения о том, какие свойства системы наиболее важны для конкретного приложения, и настраивать систему с учетом этих приоритетов.