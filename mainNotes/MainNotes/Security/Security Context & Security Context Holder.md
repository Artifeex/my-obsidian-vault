![[Pasted image 20241225105516.png]]
Когда аутентификация выполнилась, то Spring кладет Authentication объект в SecurityContext(это интерфейс, но есть его реализация SecurityContextImpl).

SecurityContext управляется классом SecurityContextHolder. Он предоставляет множество методов для работы с SecurityContext. Почистить его, обновить, добавить какие-то детали. В общем, SecurityContextHolder - это CRUD поверх SecurityContext.

![[Pasted image 20241225105944.png]]
SecurityContextHolder использует ThreadLocal переменные для хранения SecurityContext.
Каждый запрос обрабатывает свой Thread. Thread за время обработки запроса может вызывать сотни методов. Но мы можем захотеть иметь доступ к SecurityContext в любом из методов данного треда. Но где нам тогда хранить эту информацию ? И тут как раз приходит на помощь ThreadLocal переменные, с помощью которых мы можем в любом методе, если понадобится получить доступ к SecurityContext. 

Но есть и другие стратегии хранения SecurityContext(по умолчанию используется ThreadLocal и он подходит большинству веб-приложений)
![[Pasted image 20241225110550.png]]
- MODE_INHERITABLETHREADLOCAL - используется, когда у нас есть какие-то асинхронные методы. А ведь если у нас асинхронный метод, то он будет выполняться в другом потоке, которому не будут доступны ThreadLocal переменные нашего метода, который вызвал асинхронный метод. Поэтому при использовании такого мода мы можем скопировать в ThreadLocal переменные другого потока данные из нашего потока, чтобы он также имел доступ к SecurityContext.
- MODE_GLOBAL - все треды приложения будут видеть один и тот же instance, который на текущий момент хранится в SecurityContext. Не подходит для веб-приложений.

### Как получить user details?
![[Pasted image 20241225111445.png]]