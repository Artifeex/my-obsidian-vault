![[Pasted image 20240916143957.png]]
У нас есть логин форма. Когда пользователь отправил форму и залогинился успешно, сервер возвращает Set-Cookie, чтобы связать пользователя с его сессией на сервере.
Затем у пользователя при дальнейших запросах передается эта cookie.

Тогда, когда пользователь делает запрос на нашем сайте на перевод денег, то эта куки передалась, на сервере мы узнали, что это за пользователь сделал запрос и обработали запрос по переводу денег.

А теперь представим, что пользователь зашел на сайт злоумышленников и они тоже создали форму, добавили в ней скрытых полей, чтобы передать параметры для запроса на перевод денег, чтобы указать счет злоумышленников. И на этом сайте просто кнопочка win money! А т.к. форму мы можем отправлять на любой URL, то отправим на URL по переводу денег. И тогда для сервера запрос с сайта злоумышленников не будет ничем отличаться от запроса с какого-то хорошего сайта. Поскольку веб браузер просто к реквесту прикрепит куку, а на стороне сервера он определит, что даа, такой клиент есть, обработаю его запрос. 
Так и работаем CSRF. Такая защита нужна только в том случае, если мы реализуем авторизацию через cookie механизм.

Есть 2 варианта решения этой проблемы. 

### Synchronized Token Pattern
![[Pasted image 20240916144910.png]]
Дополнительно в форме на нашем сайте добавляется скрытый параметр "csrf". Это какой-то специальный, сгенерированноый токен, который хранится чаще всего в сессии пользователя на сервере. Присваивается 1 раз, когда проходим аутентификацию. И когда мы отправляем запрос, то на сервере дополнительно проверяется этот токен. Токен прикрепляется, когда генерируем форму! Поэтому злоумешленник, т.к. он генерацией формы не занимается, а этим занимаемся мы на сервере, то он не знает csrf токен и поэтому его запрос не будет удовлетворен.

![[Pasted image 20240916145343.png]]
CSRF нужно использовать только в том случае, если у нас аутентфикация через куки и для отправки запросов используется веб-сайт. Если мобильное приложение или не использеются куки, то можно выключить такую защиту.

По умолчанию csrf влючен:
![[Pasted image 20240916145511.png]]

Добавление в форму:
![[Pasted image 20240916145817.png]]
Spring добавляем в requestScope такой параметр из которого мы можем получить название для передачи как параметр и само значение токена.