Для накатывания DDL(т.е. схемы БД) мы раньше использовали Hibenate для этого подхода. Подробнее в [[In memory DB. H2]].
Но в реальных приложениях так не делают, а используют migration framework, которым и является Liquibase.

### Как устроен Liquibase

![[Pasted image 20240909222323.png]]
Есть 2 таблицы. databasechangelogLOCK используется для того, чтобы заблокировать возможность других процессов накатывать свои скрипты параллельно с нами. Т.к. у микросервисов может быть несколько инстансов и они могут все начать ломиться накатывать скрипты на БД.
И вторая таблица databasechangelog. Она нужна для того, чтобы определять какие скрипты уже были использованы, а какие нет. Перед использованием скрипта liquibase проверяет, не был ли он использован, посмотрев на id скрипта и id в таблице databasechangelog. Если в таблице нет такого id, то скрипт не использовался, он используется и в эту таблицу добавляется запись с id скрипта. Если же в таблице уже был такой же id, как у скрипта, который хотим запустить, то скрипт проигнорируется и не будет запущен.

![[Pasted image 20240909223528.png]]
changelog - это наш файл со скриптом. changelog внутри себя хранит changeset(он выполняется в одной транзакции), а каждый changeset может хранить несколько change(уже сами изменения). Хоть best practice по liquibase говорят о том, чтобы мы использовали 1 change для changeset, поскольку тогда будет удобно делать rollback и откатывать только 1 какое-то изменение, а не сразу множество change.

changelog - может быть много(это как раз 1 запись в таблице databasechangelog). Поэтому в liquibase обычно есть один мастер changelog, внутри которого подключаются changelog другие. И раз их много, то их нужно именовать и можно, например, именовать по версиям. 
![[Pasted image 20240909223739.png]]

![[Pasted image 20240909224717.png]]

Т.к. каждый changeset выполняется внутри 1 транзакции, то мы можем определить rollback поведение, которое будет выполняться после выполнения транзакции.
![[Pasted image 20240909224827.png]]

Liquibase реально крутой фреймворк. Нужно будет его потом подробнее посмотреть. 